# Hono + Better Auth + CouchDB

A complete authentication system built with **Hono**, **Better Auth**, and **CouchDB** on the **Bun** runtime. This project provides user authentication with automatic per-user database creation in CouchDB and JWT token generation for CouchDB access.

## Features

- ✅ User registration (signup)
- ✅ User login with email/password
- ✅ Session management with Better Auth
- ✅ Logout functionality
- ✅ Get current user endpoint with CouchDB JWT token
- ✅ Automatic per-user database creation in CouchDB
- ✅ CouchDB JWT token generation for authenticated users
- ✅ Docker Compose setup for CouchDB
- ✅ TypeScript support

## Project Structure

```
src/
  lib/
    auth.ts            # Better Auth configuration with CouchDB adapter
    couch.ts           # CouchDB utilities (user DB creation, JWT generation)
    env.ts             # Environment variable validation
    models.ts          # CouchDB security document models
  index.ts             # Server entrypoint
config/
  docker.ini           # CouchDB configuration
compose.yml            # Docker Compose for CouchDB
.env                   # Environment variables (generated by script)
scripts/
  generate-env.sh      # Script to generate secure secrets
```

## Setup

### 1. Install Dependencies

```bash
bun install
```

### 2. Start CouchDB with Docker Compose

```bash
docker-compose up -d
```

This will start CouchDB on `http://localhost:5984` with:
- Username: `admin`
- Password: `password`

### 3. Generate Environment Variables

Run the provided script to generate secure secrets:

```bash
chmod +x scripts/generate-env.sh
./scripts/generate-env.sh
```

This script will:
- Generate a secure `AUTH_SECRET` (48-character base64 string)
- Generate RSA key pair for CouchDB JWT signing
- Create a `.env` file with all required variables
- Update `config/docker.ini` with the public key

**Important**: The script automatically updates the CouchDB configuration. After running it, restart CouchDB:

```bash
docker-compose restart
```

### 4. Manual Environment Configuration (Optional)

If you prefer to configure manually, create a `.env` file:

```env
# Auth secret for session management (min 32 characters)
AUTH_SECRET=your-super-secret-key-min-32-characters-long-change-this

# CouchDB connection URL
COUCHDB_URL=http://admin:password@localhost:5984

# CouchDB JWT secret - RSA private key (PEM format with \n for newlines)
COUCHDB_JWT_SECRET="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"

# App configuration
PORT=3000
BETTER_AUTH_URL=http://localhost:3000
```

**Note**: The `COUCHDB_JWT_SECRET` must be an RSA private key in PEM format. Newlines should be escaped as `\n` in the `.env` file.

### 5. Start the Development Server

```bash
bun run dev
```

The server will start at `http://localhost:3000`

## API Endpoints

### 1. **Signup** - Create a new user

```bash
curl -X POST http://localhost:3000/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securePassword123",
    "name": "John Doe"
  }'
```

**Response:**

```json
{
  "user": {
    "id": "...",
    "email": "user@example.com",
    "name": "John Doe",
    "emailVerified": false
  },
  "session": {
    "id": "...",
    "userId": "...",
    "expiresAt": "..."
  }
}
```

**Note**: On successful signup, a per-user database is automatically created in CouchDB.

### 2. **Login** - Authenticate user

```bash
curl -X POST http://localhost:3000/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securePassword123"
  }' \
  -c cookies.txt
```

**Response:**

```json
{
  "user": {
    "id": "...",
    "email": "user@example.com",
    "name": "John Doe"
  },
  "session": {
    "id": "...",
    "userId": "...",
    "expiresAt": "..."
  },
  "couchjwt": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Il9kZWZhdWx0In0..."
}
```

**Note**: 
- Save cookies from the response for authenticated requests
- The `couchjwt` field contains a JWT token for authenticating with CouchDB
- The JWT token is valid for 1 hour and can be used to access the user's personal database

### 3. **Get Session** - Retrieve authenticated user info with CouchDB JWT

```bash
curl -X GET http://localhost:3000/session \
  -H "Cookie: better-auth.session_token=YOUR_SESSION_TOKEN" \
  -b cookies.txt
```

**Response:**

```json
{
  "session": {
    "expiresAt": "..."
  },
  "user": {
    "id": "...",
    "email": "user@example.com",
    "name": "John Doe"
  },
  "couchJwt": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Il9kZWZhdWx0In0..."
}
```

**Note**: This endpoint returns a fresh CouchDB JWT token that can be used to authenticate with CouchDB.

### 4. **Logout** - End user session

```bash
curl -X POST http://localhost:3000/api/auth/sign-out \
  -H "Cookie: better-auth.session_token=YOUR_SESSION_TOKEN" \
  -b cookies.txt
```

**Response:**

```json
{
  "message": "Signed out"
}
```

## Testing the Authentication Flow

### Complete Test Sequence

```bash
# 1. Create a new user
curl -X POST http://localhost:3000/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123","name":"Test User"}' \
  -c cookies.txt

# 2. Login (save cookies and CouchDB JWT from response)
curl -X POST http://localhost:3000/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}' \
  -c cookies.txt

# 3. Get current session with CouchDB JWT
curl -X GET http://localhost:3000/session \
  -b cookies.txt

# 4. Use CouchDB JWT to access user's personal database
# (Get the couchJwt from the session response)
curl -X GET http://localhost:5984/userdb_<hash>/ \
  -H "Authorization: Bearer YOUR_COUCHDB_JWT"

# 5. Logout
curl -X POST http://localhost:3000/api/auth/sign-out \
  -b cookies.txt
```

### Using the Test Script

A test script is provided to test all endpoints:

```bash
bun run test:endpoints
```

## Database

### Better Auth Database

Better Auth uses CouchDB to store authentication data in the `better_auth` database. The following documents are automatically created and managed:

- `user` - User accounts
- `session` - Active sessions
- `account` - OAuth accounts (if configured)
- `verification` - Email verification tokens

### Per-User Databases

When a user signs up, the system automatically:

1. Creates a user document in CouchDB's `_users` database
2. Creates a personal database for the user (named `userdb_<sha256_hash_of_user_id>`)
3. Sets up security documents so only the user can access their database
4. Generates a CouchDB JWT token for authenticated access

Each user's database is isolated and can only be accessed using their CouchDB JWT token.

### CouchDB JWT Tokens

The system generates RSA-signed JWT tokens that can be used to authenticate with CouchDB. These tokens:

- Are valid for 1 hour
- Include the user ID in the `sub` claim
- Include the `registered-user` role
- Can be used to access the user's personal database and other CouchDB resources based on security settings

## Development

### Technologies Used

- **Bun** - Fast JavaScript runtime
- **Hono** - Lightweight web framework
- **Better Auth** - Authentication library
- **CouchDB** - NoSQL document database
- **@amirulabu/couchdb-better-auth** - CouchDB adapter for Better Auth
- **TypeScript** - Type safety

### Scripts

- `bun run dev` - Start development server with hot reload
- `bun run src/index.ts` - Start production server
- `bun run test:endpoints` - Test all authentication endpoints
- `bun run typecheck` - Run TypeScript type checking

### CouchDB Configuration

The CouchDB instance is configured via `config/docker.ini`:

- JWT authentication is enabled
- CORS is enabled for all origins (configure for production)
- The public key for JWT verification is automatically updated by `generate-env.sh`

## Security Notes

1. **Always change `AUTH_SECRET`** in production to a secure random string (use `generate-env.sh`)
2. **Always change CouchDB admin credentials** in production (update `compose.yml` and `COUCHDB_URL`)
3. **Generate new RSA keys** for production (use `generate-env.sh`)
4. Enable HTTPS in production
5. Consider enabling `requireEmailVerification` for production use (update `src/lib/auth.ts`)
6. Review CORS settings in `config/docker.ini` and `src/index.ts` for your specific deployment
7. The CouchDB data directory (`./data`) should be backed up regularly
8. Keep the `.env` file secure and never commit it to version control
9. CouchDB JWT tokens expire after 1 hour - refresh them using the `/session` endpoint

## License

MIT
